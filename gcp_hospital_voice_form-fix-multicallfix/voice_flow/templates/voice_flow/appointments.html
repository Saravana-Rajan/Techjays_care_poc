{% extends 'voice_flow/base.html' %}
{% load static %}

{% block title %}Appointments - AI Hospital Voice System{% endblock %}

{% block extra_css %}
<style>
    .panel {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .minimal-header {
        background: #ffffff;
        border-bottom: 1px solid #f1f5f9;
        padding: 1rem 1.5rem;
        border-radius: 16px 16px 0 0;
        position: relative;
    }

    .minimal-header h2 {
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        margin: 0;
        letter-spacing: 0.025em;
        text-transform: uppercase;
    }

    .minimal-header .subtitle {
        font-size: 0.75rem;
        color: #94a3b8;
        margin: 0.25rem 0 0 0;
        font-weight: 400;
    }

    .minimal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 50%, #e2e8f0 100%);
        border-radius: 16px 16px 0 0;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px 0 rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px 0 rgba(107, 114, 128, 0.3);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(107, 114, 128, 0.4);
    }

    .table-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    /* Clickable feel for appointment rows */
    #appointments-tbody tr.interactive-row { cursor: pointer; transition: background-color 0.15s ease, box-shadow 0.15s ease; }
    #appointments-tbody tr.interactive-row:hover td { background: #f8fafc; }
    #appointments-tbody tr.interactive-row:focus td,
    #appointments-tbody tr.interactive-row:focus-within td { background: #f0f9ff; outline: 2px solid #93c5fd; outline-offset: -2px; }
    #appointments-tbody tr.selected-row td { background: #f0f9ff; box-shadow: inset 0 0 0 1px #bae6fd; }
    #appointments-tbody tr.selected-row:hover td { background: #e0f2fe; }
    /* Details styling */
    .details-group-title {
        display: inline-block;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        color: #1d4ed8;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.5rem 0.75rem;
        border-left: 4px solid #3b82f6;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(59, 130, 246, 0.15);
    }

    .field-item {
        min-height: 3.5rem;
    }

    .details-scroll {
        height: 100%;
        overflow-y: auto;
        padding-right: 0.25rem;
        padding-bottom: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .details-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .details-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    .details-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    .details-scroll::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .toast {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #94a3b8;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        color: #0f172a;
        min-width: 240px;
        max-width: 360px;
        font-size: 0.875rem;
        animation: fadeIn 0.2s ease;
    }
    .toast-success { border-left-color: #10b981; }
    .toast-error { border-left-color: #ef4444; }
    .toast-info { border-left-color: #3b82f6; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px);} to { opacity: 1; transform: translateY(0);} }
    .toast-hide { animation: fadeOut 0.2s ease forwards; }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-6px);} }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 flex flex-col min-h-0">
    {% csrf_token %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0 overflow-hidden">
        <!-- Appointments List Panel -->
        <div class="panel flex flex-col min-h-0 overflow-hidden">
            <div class="minimal-header">
                <h2>Appointments</h2>
                <p class="subtitle">Latest created appointments</p>
            </div>

            <div class="p-6 overflow-x-auto overflow-y-auto flex-1 min-h-0">
                <div id="appointments-empty" class="hidden text-sm text-slate-500">No appointments found.</div>

                <table id="appointments-table" class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="table-header hidden">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Name</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">DOB</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Reason</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Created</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-tbody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Details + Attachments Panel -->
        <div class="panel flex flex-col min-h-0 overflow-hidden">
            <div class="minimal-header">
                <h2>Appointment Details</h2>
                <p class="subtitle">Click a row to view details and insurance attachments</p>
            </div>

            <div class="p-6 space-y-5 flex-1 min-h-0 flex flex-col">
                <div id="details-empty" class="text-sm text-slate-500">No appointment selected.</div>

                <div id="details-container" class="hidden flex-1 min-h-0 flex flex-col">
                    <div id="details-scroll" class="details-scroll space-y-5 text-sm flex-1 min-h-0 h-full">
                        <div id="details-sections"></div>

                        <div class="pt-4">
                            <div class="text-slate-700 font-semibold mb-2">Insurance Attachments</div>
                            <div class="flex items-center gap-3 mb-3">
                                <input id="detail-upload-file" type="file" class="block w-full text-sm text-slate-700 border border-slate-300 rounded-md p-2 bg-white" accept="image/*,.pdf,.doc,.docx,.txt,.rtf">
                                <button id="detail-upload-btn" class="btn-primary" disabled>Upload</button>
                            </div>
                            <div id="detail-upload-status" class="text-xs text-slate-500"></div>
                            <ul id="attachments-list" class="list-disc pl-5 text-sm text-slate-700 space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const appointmentsApiUrl = '{% url "voice_flow:appointment_api" %}';
    const attachmentApiBase = '{% url "voice_flow:appointment_api" %}';

    function setUploading(isUploading) {
        const btn = document.getElementById('upload-btn');
        const status = document.getElementById('upload-status');
        btn.disabled = isUploading || !document.getElementById('upload-file').files.length;
        status.textContent = isUploading ? 'Uploadingâ€¦' : '';
    }

    function showPopup(message, type = 'info') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        const el = document.createElement('div');
        el.className = 'toast toast-' + (type || 'info');
        el.setAttribute('role', 'status');
        el.setAttribute('aria-live', 'polite');
        el.textContent = message;
        container.appendChild(el);
        const timeout = setTimeout(() => {
            el.classList.add('toast-hide');
            setTimeout(() => el.remove(), 200);
        }, 3000);
        el.addEventListener('click', () => {
            clearTimeout(timeout);
            el.remove();
        });
    }

    function renderAppointments(rows) {
        const tbody = document.getElementById('appointments-tbody');
        const empty = document.getElementById('appointments-empty');
        const thead = document.querySelector('#appointments-table thead');
        tbody.innerHTML = '';
        if (!rows || rows.length === 0) {
            empty.classList.remove('hidden');
            if (thead) thead.classList.add('hidden');
            return;
        }
        empty.classList.add('hidden');
        if (thead) thead.classList.remove('hidden');
        rows.forEach(item => {
            const tr = document.createElement('tr');
            tr.classList.add('interactive-row');
            const name = item.full_name || '';
            const dob = item.dob || '';
            const reason = (item.reason_for_visit || '').slice(0, 60);
            const created = item.created_at || '';
            tr.dataset.id = item.id;
            tr.tabIndex = 0;
            tr.setAttribute('role', 'button');
            tr.setAttribute('aria-label', `View details for ${name || 'appointment'}`);
            tr.innerHTML = `
                <td class="px-3 py-2 text-slate-700 cursor-pointer hover:bg-slate-50" data-click="details">${name}</td>
                <td class="px-3 py-2 text-slate-700 cursor-pointer hover:bg-slate-50" data-click="details">${dob}</td>
                <td class="px-3 py-2 text-slate-700 cursor-pointer hover:bg-slate-50" data-click="details">${reason}</td>
                <td class="px-3 py-2 text-slate-500 cursor-pointer hover:bg-slate-50" data-click="details">${created}</td>
            `;
            tbody.appendChild(tr);

            tr.addEventListener('click', (ev) => {
                const target = ev.target;
                if (target && target.getAttribute('data-click') === 'details') {
                    showDetailsById(item.id);
                }
            });

            tr.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    showDetailsById(item.id);
                }
            });

            if (currentDetail && currentDetail.id === item.id) {
                tr.classList.add('selected-row');
            }
        });
    }

    async function fetchAppointments() {
        try {
            const res = await fetch(appointmentsApiUrl);
            const data = await res.json();
            if (data && data.success) {
                renderAppointments(data.data || []);
            } else {
                renderAppointments([]);
            }
        } catch (e) {
            renderAppointments([]);
        }
    }

    let currentDetail = null;

    function fieldLabel(key) {
        const map = {
            full_name: 'Full Name',
            dob: 'Date of Birth',
            contact_number: 'Contact Number',
            emergency_contact_phone: 'Emergency Contact Phone',
            guardian_contact: 'Guardian Contact',
            symptom_duration: 'Symptom Duration',
            pain_level: 'Pain Level',
            medical_history: 'Medical History',
            family_history: 'Family History',
            school_grade: 'School / Grade',
            interpreter_need: 'Interpreter Needed',
            consent_share_records: 'Consent to Share Records',
            preferred_communication_method: 'Preferred Communication',
            appointment_availability: 'Appointment Availability',
            created_at: 'Created At',
            updated_at: 'Updated At',
        };
        if (map[key]) return map[key];
        return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatValue(key, value) {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'boolean') return value ? 'Yes' : 'No';
        if (key === 'dob') return value; // already ISO string
        return String(value);
    }

    const detailGroups = [
        { title: 'Patient Identification', fields: ['full_name','dob','gender','contact_number','email','address','preferred_language','emergency_contact_name','emergency_contact_phone','relationship_to_patient'] },
        { title: 'Visit & Care Context', fields: ['caller_type','reason_for_visit','visit_type','primary_physician','referral_source'] },
        { title: 'Medical Information', fields: ['symptoms','symptom_duration','pain_level','current_medications','allergies','medical_history','family_history'] },
        { title: 'Accessibility & Support', fields: ['interpreter_need','interpreter_language','accessibility_needs','dietary_needs'] },
        { title: 'Consent & Preferences', fields: ['consent_share_records','preferred_communication_method','appointment_availability'] },
        { title: 'Timestamps', fields: ['created_at','updated_at'] },
    ];

    function renderDetailsSections(detail) {
        const container = document.getElementById('details-sections');
        container.innerHTML = '';
        detailGroups.forEach(group => {
            const section = document.createElement('div');
            section.innerHTML = `
                <div class="details-group-title mb-2">${group.title}</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${group.fields.map(k => {
                        const val = formatValue(k, detail[k]);
                        return `<div class=\"field-item\">
                                    <div class=\"text-slate-400\">${fieldLabel(k)}</div>
                                    <div class=\"font-medium text-slate-800\">${val}</div>
                                </div>`;
                    }).join('')}
                </div>
            `;
            container.appendChild(section);
        });
    }

    function renderAttachments(detail) {
        const list = document.getElementById('attachments-list');
        list.innerHTML = '';
        const attachments = (detail && detail.attachments) || [];
        attachments.forEach(att => {
            const li = document.createElement('li');
            const link = document.createElement('a');
            link.href = att.url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.className = 'text-blue-600 hover:underline';
            link.textContent = att.original_name;
            li.appendChild(link);
            const meta = document.createElement('div');
            meta.className = 'text-xs text-slate-500';
            meta.textContent = `${att.content_type} â€¢ ${(att.size_bytes/1024).toFixed(1)} KB`;
            li.appendChild(meta);
            list.appendChild(li);
        });
    }

    async function fetchAppointmentDetail(appointmentId) {
        const res = await fetch(`/api/appointments/${appointmentId}/`);
        if (!res.ok) return null;
        const body = await res.json();
        if (!body || !body.success) return null;
        return body.data;
    }

    async function refreshDetail(appointmentId) {
        const detail = await fetchAppointmentDetail(appointmentId);
        if (!detail) return;
        currentDetail = detail;
        renderDetailsSections(detail);
        renderAttachments(detail);
    }

    async function showDetailsById(appointmentId) {
        document.getElementById('details-empty').classList.add('hidden');
        document.getElementById('details-container').classList.remove('hidden');
        document.getElementById('detail-upload-status').textContent = '';
        document.getElementById('detail-upload-btn').disabled = true;
        document.getElementById('detail-upload-file').value = '';
        const scrollEl = document.getElementById('details-scroll');
        if (scrollEl) scrollEl.scrollTop = 0;
        // Visually select the clicked/active row
        document.querySelectorAll('#appointments-tbody tr').forEach(r => {
            r.classList.toggle('selected-row', String(r.dataset.id) === String(appointmentId));
        });
        await refreshDetail(appointmentId);
        if (scrollEl) scrollEl.scrollTop = 0;
    }

    async function uploadAttachment(appointmentId, file) {
        if (file.size > 10 * 1024 * 1024) {
            document.getElementById('detail-upload-status').textContent = 'File too large (max 10MB).';
            showPopup('File too large (max 10MB).', 'error');
            return;
        }
        const form = new FormData();
        form.append('file', file);
        try {
            document.getElementById('detail-upload-status').textContent = 'Uploadingâ€¦';
            const res = await fetch(`/api/appointments/${appointmentId}/attachments/`, { method: 'POST', body: form });
            const data = await res.json();
            if (data && data.success) {
                document.getElementById('detail-upload-status').textContent = 'Uploaded.';
                showPopup('Document uploaded successfully.', 'success');
            } else {
                document.getElementById('detail-upload-status').textContent = (data && data.message) || 'Upload failed.';
                showPopup((data && data.message) || 'Upload failed.', 'error');
            }
        } catch (e) {
            document.getElementById('detail-upload-status').textContent = 'Upload error.';
            showPopup('Upload error.', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchAppointments();
        const detailFile = document.getElementById('detail-upload-file');
        const detailBtn = document.getElementById('detail-upload-btn');
        detailFile.addEventListener('change', () => {
            detailBtn.disabled = !detailFile.files.length || !currentDetail;
        });
        detailBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!currentDetail || !detailFile.files.length) return;
            await uploadAttachment(currentDetail.id, detailFile.files[0]);
            detailFile.value = '';
            detailBtn.disabled = true;
            await refreshDetail(currentDetail.id);
        });
    });
</script>
{% endblock %}


